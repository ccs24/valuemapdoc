define("mod_valuemapdoc/tabulatormap",["mod_valuemapdoc/tabulatorlib","core/ajax","core_user/repository","core/notification","jquery"],(function(Tabulator,Ajax,UserRepository,Notification,$){return{init:function(courseid,cmid,filtercmid,columns){if(console.log("[tabulatormap] Module loaded"),console.log("[tabulatormap] Course ID:",courseid,"CM ID:",cmid,"Filter CM ID:",filtercmid),console.log("[DEBUG] Columns received:",columns),"string"==typeof columns)try{columns=JSON.parse(columns),console.log("[DEBUG] Parsed columns:",columns)}catch(e){return void console.error("[tabulatormap] Error parsing columns:",e)}if(Array.isArray(columns)){var el=document.querySelector("#valuemap-table-js");if(el){var table,groupfilterEl=document.querySelector("#groupfilter"),groupid=groupfilterEl&&parseInt(groupfilterEl.value)||0,fullscreenBtn=document.querySelector("#toggle-fullscreen");fullscreenBtn&&fullscreenBtn.addEventListener("click",(function(){document.body.classList.toggle("valuemapdoc-fullscreen"),document.body.classList.contains("valuemapdoc-fullscreen")?fullscreenBtn.textContent="‚ùé Zamknij pe≈Çny ekran":fullscreenBtn.textContent="üî≥ Pe≈Çny ekran"}));var enhancedColumns=function(columns){var enhancedColumns=[{formatter:"rowSelection",titleFormatter:"rowSelection",hozAlign:"center",headerSort:!1,width:50}];return columns.forEach((function(col){enhancedColumns.push({title:col.title,field:col.field,hozAlign:col.hozAlign,headerSort:col.headerSort,width:col.width,headerFilter:"input",editable:function(cell){return 1!==cell.getRow().getData().ismaster},editor:"textarea"})})),enhancedColumns.push({title:"Autor",field:"username",hozAlign:"left",headerSort:!0,width:120,headerFilter:"input",editable:!1,formatter:function(cell,formatterParams){var value=cell.getValue();return 1===cell.getRow().getData().ismaster?'<i class="fa fa-star text-warning" title="Master entry"></i> '+value:value}}),enhancedColumns}(columns);Ajax.call([{methodname:"mod_valuemapdoc_get_entries",args:{courseid:parseInt(courseid),cmid:parseInt(cmid),include_master:filtercmid?parseInt(filtercmid):0,groupid:groupid}}])[0].done((function(response){console.log("[tabulatormap] Entries loaded:",response.length,"records");var currentUsername=function(response){var currentUserId=M.cfg.userid,userEntry=response.find((function(entry){return entry.userid==currentUserId}));return userEntry&&userEntry.username?userEntry.username:M.cfg.fullname||M.cfg.username||"Ja"}(response);function reloadTableData(){Ajax.call([{methodname:"mod_valuemapdoc_get_entries",args:{courseid:parseInt(courseid),cmid:parseInt(cmid),include_master:filtercmid?parseInt(filtercmid):0,groupid:groupid}}])[0].done((function(response){console.log("[tabulatormap] Table data reloaded"),table.setData(response)})).fail((function(error){console.error("[tabulatormap] Error reloading data:",error)}))}(table=new Tabulator(el,{data:response,columns:enhancedColumns,layout:"fitDataTable",height:"100%",width:"100%",pagination:!0,paginationSize:20,placeholder:"Brak danych do wy≈õwietlenia",rowFormatter:function(row){1===row.getData().ismaster&&(row.getElement().style.backgroundColor="#eaffea",row.getElement().classList.add("ismaster"))},selectable:!0})).on("tableBuilt",(function(){console.log("[tabulatormap] Table built successfully"),table.setHeaderFilterValue("username",currentUsername),function(table,currentUsername){var toolbar=document.querySelector(".btn-toolbar");if(!toolbar)return;var filterContainer=document.createElement("div");filterContainer.className="btn-group ms-auto",filterContainer.setAttribute("role","group");var toggleButton=document.createElement("button");toggleButton.className="btn btn-outline-info btn-sm",toggleButton.setAttribute("type","button"),toggleButton.innerHTML='<i class="fa fa-user"></i> Tylko moje',toggleButton.title="Prze≈ÇƒÖcz miƒôdzy moimi wpisami a wszystkimi";var showingOnlyMine=!0;toggleButton.addEventListener("click",(function(){showingOnlyMine?(table.clearHeaderFilter("username"),toggleButton.innerHTML='<i class="fa fa-users"></i> Wszystkie',toggleButton.className="btn btn-outline-secondary btn-sm",showingOnlyMine=!1):(table.setHeaderFilterValue("username",currentUsername),toggleButton.innerHTML='<i class="fa fa-user"></i> Tylko moje',toggleButton.className="btn btn-outline-info btn-sm",showingOnlyMine=!0)})),filterContainer.appendChild(toggleButton),toolbar.appendChild(filterContainer)}(table,currentUsername)})),table.on("rowSelectionChanged",(function(data,rows){var bulkActions=document.querySelector("#bulk-actions");bulkActions&&(data.length>0?bulkActions.style.display="block":bulkActions.style.display="none")})),table.on("cellEdited",(function(cell){var updatedData=cell.getRow().getData();Ajax.call([{methodname:"mod_valuemapdoc_update_cell",args:{id:updatedData.id,field:cell.getField(),value:cell.getValue()}}])[0].done((function(response){console.log("[tabulatormap] Cell updated successfully")})).fail((function(error){console.error("[tabulatormap] Error updating cell:",error),alert("Nie uda≈Ço siƒô zapisaƒá zmian."),cell.restoreOldValue()}))})),table.on("rowDblClick",(function(e,row){var data=row.getData();if(1===data.ismaster){var rateUrl=M.cfg.wwwroot+"/mod/valuemapdoc/edit.php?id="+cmid+"&entryid="+data.id;window.open(rateUrl)}}));var searchInput=document.querySelector("#valuemap-search");searchInput&&searchInput.addEventListener("input",(function(){var filterValue=this.value.toLowerCase();table.setFilter((function(data){return columns.some((function(col){var field=col.field,fieldValue=data[field];return fieldValue&&fieldValue.toString().toLowerCase().includes(filterValue)}))}))}));var editBulkButton=document.querySelector("#edit-bulk-button");editBulkButton&&editBulkButton.addEventListener("click",(function(){var selectedData=table.getSelectedData();if(selectedData.length)if(1===selectedData.length){var id=selectedData[0].id,url=M.cfg.wwwroot+"/mod/valuemapdoc/edit.php?id="+cmid+"&entryid="+id;window.location.href=url}else{var ids=selectedData.map((function(r){return r.id})),bulkUrl=new URL(M.cfg.wwwroot+"/mod/valuemapdoc/edit_bulk.php");bulkUrl.searchParams.append("id",cmid),bulkUrl.searchParams.append("entryids",ids.join(",")),window.open(bulkUrl.toString())}else alert("Proszƒô zaznaczyƒá co najmniej jeden rekord.")}));var duplicateBulkButton=document.querySelector("#duplicate-bulk-button");duplicateBulkButton&&duplicateBulkButton.addEventListener("click",(function(){var selectedData=table.getSelectedData();if(selectedData.length){var entryids=selectedData.map((function(entry){return entry.id}));Ajax.call([{methodname:"mod_valuemapdoc_create_entries_bulk",args:{entryids:entryids,cmid:cmid}}])[0].done((function(response){console.log("[tabulatormap] Entries duplicated successfully"),reloadTableData(),table.deselectRow()})).fail((function(error){console.error("[tabulatormap] Error duplicating entries:",error),alert("Nie uda≈Ço siƒô powieliƒá wpis√≥w.")}))}else alert("Zaznacz rekordy do powielenia.")}));var emptyBulkButton=document.querySelector("#empty-bulk-button");emptyBulkButton&&emptyBulkButton.addEventListener("click",(function(){Ajax.call([{methodname:"mod_valuemapdoc_create_entries_bulk",args:{entryids:[],cmid:cmid}}])[0].done((function(response){console.log("[tabulatormap] Empty entry created"),reloadTableData(),table.deselectRow()})).fail((function(error){console.error("[tabulatormap] Error creating empty entries:",error),alert("Nie uda≈Ço siƒô utworzyƒá pustego wpisu.")}))}));var deleteBulkButton=document.querySelector("#delete-bulk-button");deleteBulkButton&&deleteBulkButton.addEventListener("click",(function(){var selectedData=table.getSelectedData();if(selectedData.length){if(confirm("Czy na pewno chcesz usunƒÖƒá zaznaczone wpisy?")){var entryids=selectedData.map((function(entry){return entry.id}));Ajax.call([{methodname:"mod_valuemapdoc_delete_bulk",args:{entryids:entryids,cmid:cmid}}])[0].done((function(response){console.log("[tabulatormap] Entries deleted successfully"),reloadTableData()})).fail((function(error){console.error("[tabulatormap] Error deleting entries:",error),alert("Nie uda≈Ço siƒô usunƒÖƒá wpis√≥w.")}))}}else alert("Zaznacz rekordy do usuniƒôcia.")}));var generateButton=document.querySelector("#generate-button");generateButton&&generateButton.addEventListener("click",(function(){var selectedData=table.getSelectedData();if(selectedData.length){var templateSelect=document.querySelector("#templateid");if(templateSelect&&templateSelect.value){var entryIds=selectedData.map((function(entry){return entry.id})),form=document.createElement("form");form.method="post",form.action=M.cfg.wwwroot+"/mod/valuemapdoc/generate.php";var inputs={id:cmid,templateid:templateSelect.value,entryids:entryIds};for(var name in inputs){var input=document.createElement("input");input.type="hidden",input.name=name,input.value=Array.isArray(inputs[name])?inputs[name].join(","):inputs[name],form.appendChild(input)}document.body.appendChild(form),form.submit()}else alert("Wybierz szablon przed generowaniem dokumentu.")}else alert("Proszƒô zaznaczyƒá co najmniej jeden rekord.")}))})).fail((function(error){console.error("[tabulatormap] Error loading entries:",error),alert("B≈ÇƒÖd podczas ≈Çadowania danych: "+(error.message||"Nieznany b≈ÇƒÖd"))}))}else console.warn("[tabulatormap] Table element not found")}else console.error("[tabulatormap] Columns is not an array")}}}));

//# sourceMappingURL=tabulatormap.min.js.map