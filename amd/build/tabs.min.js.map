{"version":3,"file":"tabs.min.js","sources":["../src/tabs.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Lightweight tabs handler for Moodle plugin.\n *\n * @copyright  2024\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([], function() {\n    return {\n        /**\n         * Initialize tab switching based on URL hash and clicks.\n         */\n        init: function() {\n            /**\n             * Shows the selected tab and activates the corresponding navigation link.\n             *\n             * @param {string} hash - The ID of the tab to activate (including #).\n             */\n            function showTab(hash) {\n                document.querySelectorAll('#valuemapdoc-tabs .tab-pane').forEach(function(tab) {\n                    tab.classList.remove('active', 'show');\n                });\n                document.querySelectorAll('#valuemapdoc-tabs .nav-link').forEach(function(link) {\n                    link.classList.remove('active');\n                });\n\n                const activeTab = document.querySelector(hash);\n                const activeLink = document.querySelector('[data-href=\"' + hash + '\"]');\n\n                if (activeTab) {\n                    activeTab.classList.add('active', 'show');\n                }\n                if (activeLink) {\n                    activeLink.classList.add('active');\n                }\n            }\n\n            document.querySelectorAll('#valuemapdoc-tabs .nav-link').forEach(function(link) {\n                link.addEventListener('click', function(e) {\n                    e.preventDefault();\n                    const targetHash = this.getAttribute('data-href');\n                    if (targetHash) {\n                        if (targetHash === '#content-tab') {\n                            import('mod_valuemapdoc/tablecontent').then((module) => {\n                                module.init();\n\n                                const spinner = document.querySelector('#spinner-indicator');\n                                const isPending = sessionStorage.getItem('valuemapdoc_pending_generation') === '1';\n                                const startTime = Date.now();\n\n                                if (spinner && isPending) {\n                                    spinner.classList.remove('d-none');\n                                }\n\n                                /**\n                                 * Polls the server every 5 seconds to check if any content document has status 'ready'.\n                                 * Hides spinner once a document is ready or after a timeout.\n                                 */\n                                function checkDocumentsReady() {\n                                    require(['core/ajax'], function(Ajax) {\n                                        const container = document.querySelector('#valuemapdoc-content-table');\n                                        if (!container) { return; }\n\n                                        const courseid = container.dataset.courseid;\n                                        const cmid = container.dataset.cmid;\n\n                                        Ajax.call([{\n                                            methodname: 'mod_valuemapdoc_get_content_entries',\n                                            args: {\n                                                courseid: courseid,\n                                                cmid: cmid,\n                                                include_master: 0\n                                            }\n                                        }])[0].then(function(entries) {\n                                            const ready = entries.length && entries.some(e => e.status === 'ready');\n                                            const expired = (Date.now() - startTime > 20000); // 20s timeout\n\n                                            if (ready || expired) {\n                                                spinner?.classList.add('d-none');\n                                                sessionStorage.removeItem('valuemapdoc_pending_generation');\n                                            } else {\n                                                setTimeout(checkDocumentsReady, 5000);\n                                            }\n                                        });\n                                    });\n                                }\n\n                                if (isPending) {\n                                    checkDocumentsReady();\n                                }\n\n                                showTab(targetHash);\n                            });\n                        } else {\n                            history.pushState(null, null, targetHash);\n                            showTab(targetHash);\n                        }\n                    }\n                });\n            });\n\n            if (window.location.hash) {\n                showTab(window.location.hash);\n            } else {\n                const firstTabLink = document.querySelector('#valuemapdoc-tabs .nav-link[data-href]');\n                if (firstTabLink) {\n                    const firstHash = firstTabLink.getAttribute('data-href');\n                    if (firstHash) {\n                        history.replaceState(null, null, firstHash);\n                        showTab(firstHash);\n                    }\n                }\n            }\n\n            window.addEventListener('hashchange', function() {\n                if (window.location.hash) {\n                    showTab(window.location.hash);\n                }\n            });\n        }\n    };\n});"],"names":["define","init","showTab","hash","document","querySelectorAll","forEach","tab","classList","remove","link","activeTab","querySelector","activeLink","add","addEventListener","e","preventDefault","targetHash","this","getAttribute","then","module","spinner","isPending","sessionStorage","getItem","startTime","Date","now","checkDocumentsReady","require","Ajax","container","courseid","dataset","cmid","call","methodname","args","include_master","entries","ready","length","some","status","expired","removeItem","setTimeout","history","pushState","window","location","firstTabLink","firstHash","replaceState"],"mappings":";;;;;;GAsBAA,8BAAO,IAAI,iBACA,CAIHC,KAAM,oBAMOC,QAAQC,MACbC,SAASC,iBAAiB,+BAA+BC,SAAQ,SAASC,KACtEA,IAAIC,UAAUC,OAAO,SAAU,WAEnCL,SAASC,iBAAiB,+BAA+BC,SAAQ,SAASI,MACtEA,KAAKF,UAAUC,OAAO,mBAGpBE,UAAYP,SAASQ,cAAcT,MACnCU,WAAaT,SAASQ,cAAc,eAAiBT,KAAO,MAE9DQ,WACAA,UAAUH,UAAUM,IAAI,SAAU,QAElCD,YACAA,WAAWL,UAAUM,IAAI,aAIjCV,SAASC,iBAAiB,+BAA+BC,SAAQ,SAASI,MACtEA,KAAKK,iBAAiB,SAAS,SAASC,GACpCA,EAAEC,uBACIC,WAAaC,KAAKC,aAAa,aACjCF,aACmB,iBAAfA,kpBACuCG,MAAMC,SACzCA,OAAOrB,aAEDsB,QAAUnB,SAASQ,cAAc,sBACjCY,UAAyE,MAA7DC,eAAeC,QAAQ,kCACnCC,UAAYC,KAAKC,MAEnBN,SAAWC,WACXD,QAAQf,UAAUC,OAAO,UAoCzBe,oBA7BKM,sBACLC,QAAQ,CAAC,cAAc,SAASC,YACtBC,UAAY7B,SAASQ,cAAc,kCACpCqB,uBAECC,SAAWD,UAAUE,QAAQD,SAC7BE,KAAOH,UAAUE,QAAQC,KAE/BJ,KAAKK,KAAK,CAAC,CACPC,WAAY,sCACZC,KAAM,CACFL,SAAUA,SACVE,KAAMA,KACNI,eAAgB,MAEpB,GAAGnB,MAAK,SAASoB,eACXC,MAAQD,QAAQE,QAAUF,QAAQG,MAAK5B,GAAkB,UAAbA,EAAE6B,SAC9CC,QAAWlB,KAAKC,MAAQF,UAAY,IAEtCe,OAASI,SACTvB,MAAAA,SAAAA,QAASf,UAAUM,IAAI,UACvBW,eAAesB,WAAW,mCAE1BC,WAAWlB,oBAAqB,WAO5CA,GAGJ5B,QAAQgB,gBAGZ+B,QAAQC,UAAU,KAAM,KAAMhC,YAC9BhB,QAAQgB,oBAMpBiC,OAAOC,SAASjD,KAChBD,QAAQiD,OAAOC,SAASjD,UACrB,OACGkD,aAAejD,SAASQ,cAAc,6CACxCyC,aAAc,OACRC,UAAYD,aAAajC,aAAa,aACxCkC,YACAL,QAAQM,aAAa,KAAM,KAAMD,WACjCpD,QAAQoD,aAKpBH,OAAOpC,iBAAiB,cAAc,WAC9BoC,OAAOC,SAASjD,MAChBD,QAAQiD,OAAOC,SAASjD"}